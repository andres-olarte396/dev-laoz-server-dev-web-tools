services:
  # Base de datos MongoDB
  mongodb:
    image: mongo:6.0
    container_name: webtools-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: webtools
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - webtools-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Repository Loader (Bootstrap)
  repo-loader:
    image: alpine/git
    container_name: webtools-repo-loader
    volumes:
      - ../..:/app/repos
      - ./scripts:/scripts
      - ./CONFIGURATION.md:/CONFIGURATION.md
      - ./nginx_repos.conf:/nginx_repos.conf
    entrypoint: ["/bin/sh", "-c"]
    command: ["sed -i 's/\\r$//' /scripts/*.sh && /scripts/ensure_repos.sh /app/repos"]
    networks:
      - webtools-network

  # Servidor Nginx
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    container_name: webtools-nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      # Montar todo el directorio padre para acceder a todos los repositorios clonados
      - ../..:/var/www/html
      # Sobrescribir index.html y js espec√≠fico del dashboard
      - ./index.html:/var/www/html/index.html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx_repos.conf:/etc/nginx/includes/nginx_repos.conf:ro
      - ./js:/var/www/html/js:ro
    networks:
      - webtools-network
    depends_on:
      repo-loader:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3



networks:
  webtools-network:
    driver: bridge
    name: webtools-network

volumes:
  mongodb_data:
    name: webtools-mongodb-data
  mongodb_config:
    name: webtools-mongodb-config
